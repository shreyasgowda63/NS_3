# ns-3 CI/CD script with the Docker jobs
#
# Contains the jobs to build and publish ns-3 Docker images
#
# Author: Eduardo Nuno Almeida <enmsa@outlook.pt> [INESC TEC and FEUP, Portugal]

#############################
# BASE DOCKER CONFIGURATION
#############################
.base-docker:
  stage: docker
  image: docker
  services:
    - docker:dind
  interruptible: true

  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: 1

  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    # TODO: Login to Docker Hub (commented until Docker Hub account is created)
    # - docker login -u nsnam -p $DOCKER_HUB_PASSWORD
    # TODO: Save Docker Hub password in GitLab's secrets

  # TODO: Uncomment before merging
  # rules:
  #   - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

#############################
# BUILD DOCKER IMAGES
#############################
.build-docker:
  extends: .base-docker

  script:
    - docker pull $CI_REGISTRY_IMAGE/ns-3:base-image || true
    - docker build --pull -t $CI_REGISTRY_IMAGE/ns-3:$DOCKER_TAG
      $DOCKER_TARGET
      $DOCKER_BUILD_ARGS
      --label "maintainer=nsnam"
      --label "created=${CI_JOB_STARTED_AT}"
      --label "version=${CI_COMMIT_SHA}"
      .
    - docker push $CI_REGISTRY_IMAGE/ns-3:$DOCKER_TAG
    # Push to Docker Hub (commented until Docker Hub account is created)
    # - if [[ $PUSH_TO_DOCKERHUB ]]; then
    #   docker tag $CI_REGISTRY_IMAGE/ns-3:$DOCKER_TAG nsnam/ns-3:$DOCKER_TAG ;
    #   docker push nsnam/ns-3:$DOCKER_TAG ;
    #   fi

build-docker-base-image:
  extends: .build-docker
  variables:
    DOCKER_TAG: "base-image"
    DOCKER_TARGET: "--target=base-image"

build-docker-dev-default:
  extends: .build-docker
  needs: ["build-docker-base-image"]
  variables:
    DOCKER_TAG: "dev-default"
    DOCKER_BUILD_ARGS: "--build-arg build_profile=default"
    PUSH_TO_DOCKERHUB: 1

#############################
# PUSH DOCKER IMAGES
#############################

# Push the "dev-default" tag as the "latest" tag.
# This is temporary until images for stable releases of ns-3 are published.
# Then, the "latest" tag should point to the latest stable release, which will be the default
# image pulled by users.

push-docker-latest:
  extends: .base-docker
  needs: ["build-docker-dev-default"]
  script:
    - docker pull $CI_REGISTRY_IMAGE/ns-3:dev-default
    - docker tag $CI_REGISTRY_IMAGE/ns-3:dev-default $CI_REGISTRY_IMAGE/ns-3:latest
    - docker push $CI_REGISTRY_IMAGE/ns-3:latest
    # Push to Docker Hub (commented until Docker Hub account is created)
    # - docker tag $CI_REGISTRY_IMAGE/ns-3:dev-default nsnam/ns-3:latest
    # - docker push nsnam/ns-3:latest
