# NS3 CI script for testing

# Defines the steps to run the tests
# Inherit with "extends: .base-test" and remember to set
# the following variables: COMPILER (g++, clang++, ...) and
# MODE (debug, default, optimized)

.base-test:
  image: archlinux
  before_script:
    # add the core-debug repo to pacman.conf
    - printf "\n%s\n%s\n" "[core-debug]" "Include = /etc/pacman.d/mirrorlist" >> /etc/pacman.conf
    - pacman-key --init
    - pacman -Syu --noconfirm
      base-devel cmake ninja ccache valgrind
      python
      boost gsl gtk3
      glibc-debug
  script:
    - mkdir -p $CCACHE_BASEDIR_VALUE
    - export CCACHE_BASEDIR=${PWD}
    - export CCACHE_DIR=${PWD}/$CCACHE_BASEDIR_VALUE
    # missing the flag --disable-python
    - ./ns3 configure -d $MODE -GNinja --enable-examples --enable-tests --disable-gtk
    - ./ns3 build
    - if [ "$CI_JOB_STAGE" == "test" ];
      then ./test.py -n $VALGRIND_FLAG $FULLNESS;
      fi
  cache:
    key: "ccache-$CI_JOB_NAME"
    paths:
      - $CCACHE_BASEDIR_VALUE/
  variables:
    COMPILER: g++
    CCACHE_BASEDIR_VALUE: ns-3-ccache-storage
    VALGRIND_FLAG: ""
    FULLNESS: ""
    # workaround for Valgrind on Archlinux https://bbs.archlinux.org/viewtopic.php?pid=2036171#p2036171
    DEBUGINFOD_URLS: "https://debuginfod.archlinux.org"

# Run the test.py script with files compiled in debug mode
daily-test-debug:
  stage: test
  extends: .base-test
  variables:
    MODE: debug
  rules:
    - if: $RELEASE == "daily"
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
  tags:
    - nsnam
    - linux

# Run the test.py script with files compiled in default mode
daily-build-default:
  stage: build
  extends: .base-test
  variables:
    MODE: default
  rules:
    - if: $RELEASE == "daily"
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual

daily-test-default:
  stage: test
  extends: .base-test
  needs: ["daily-build-default"]
  cache:
    key: "daily-build-default"
    paths:
      - $CCACHE_BASEDIR_VALUE/
  variables:
    MODE: default
  rules:
    - if: $RELEASE == "daily"
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual

# Run the test.py script with files compiled in optimized mode
daily-build-optimized:
  stage: build
  extends: .base-test
  variables:
    MODE: optimized
  rules:
    - if: $RELEASE == "daily"
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual

daily-test-optimized:
  stage: test
  extends: .base-test
  needs: ["daily-build-optimized"]
  cache:
    key: "daily-build-optimized"
    paths:
      - $CCACHE_BASEDIR_VALUE/
  variables:
    MODE: optimized
  rules:
    - if: $RELEASE == "daily"
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual

### Valgrind tests
# Run the test.py script with files compiled in optimized mode + valgrind (daily)
daily-test-optimized-valgrind:
  stage: test
  extends: .base-test
  variables:
    MODE: optimized
    VALGRIND_FLAG: -g
  rules:
    - if: $RELEASE == "daily"
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
  tags:
    - nsnam
    - linux

# Run the test.py script with files compiled in debug mode
weekly-test-debug-valgrind:
  stage: test
  extends: .base-test
  variables:
    MODE: debug
    VALGRIND_FLAG: -g
  rules:
    - if: $RELEASE == "weekly"
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
  tags:
    - nsnam
    - linux

# Run the test.py script with files compiled in default mode
weekly-test-default-valgrind:
  stage: test
  extends: .base-test
  variables:
    MODE: default
    VALGRIND_FLAG: -g
  rules:
    - if: $RELEASE == "weekly"
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
  tags:
    - nsnam
    - linux

# Run the test.py script with files compiled in optimized mode
weekly-test-optimized-valgrind:
  stage: test
  extends: .base-test
  variables:
    MODE: optimized
    VALGRIND_FLAG: -g
  rules:
    - if: $RELEASE == "weekly"
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
  tags:
    - nsnam
    - linux

# Do a check for the TAKES_FOREVER jobs, only in optimized mode
weekly-test-takes-forever-optimized:
  stage: test
  extends: .base-test
  variables:
    MODE: optimized
    FULLNESS: "-f TAKES_FOREVER"
  rules:
    - if: $RELEASE == "weekly"
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
  tags:
    - nsnam
    - linux
